-- ==================== 1. 防多开检测 ====================
local function AntiMultiOpen()
    local existingGui = game:GetService("CoreGui"):FindFirstChild("KJY_Team_AntiDup")
    if existingGui then
        game:GetService("Players").LocalPlayer:Kick("Script already running! Please wait.")
        return false
    end
    local antiDupGui = Instance.new("ScreenGui")
    antiDupGui.Name = "KJY_Team_AntiDup"
    antiDupGui.Parent = game:GetService("CoreGui")
    game:GetService("Players").PlayerRemoving:Connect(function(player)
        if player == game:GetService("Players").LocalPlayer then
            antiDupGui:Destroy()
        end
    end)
    return true
end
if not AntiMultiOpen() then return end

-- ==================== 2. 从您指定的链接加载GUI库 ====================
-- 注意：这里使用了您提供的URL
local c = loadstring(game:HttpGet("https://raw.githubusercontent.com/qiaoxxyxx/Roblox/refs/heads/main/ui"))()

-- ==================== 3. 游戏服务与基础设置 ====================
local d = true
local e = game:GetService("Players").LocalPlayer

-- 防AFK
e.Idled:Connect(function()
    game:GetService("VirtualUser"):Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    wait(1)
    game:GetService("VirtualUser"):Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- ==================== 4. 白名单验证UI函数 ====================
-- 注意：此函数 f(g) 需要您根据实际使用的GUI库API进行适配
local function ShowVerificationUI(isSuccess)
    -- 这里应使用您加载的GUI库 (变量c) 来创建验证窗口
    -- 示例: c:CreateVerificationWindow({Success = isSuccess})
    print("验证结果: " .. (isSuccess and "通过" or "失败"))
    -- 临时实现：等待3秒模拟原流程
    wait(3)
end

-- ==================== 5. 白名单验证逻辑 ====================
local function UltimateValidation()
    local playerName = game.Players.LocalPlayer.Name
    local success, isWhitelisted = pcall(function()
        local response = game:HttpGet("https://raw.githubusercontent.com/qiaoxxyxx/Roblox/refs/heads/main/whitelist.txt")
        local whitelist = {}
        for name in response:gmatch("[^,]+") do
            whitelist[name:gsub("%s+", "")] = true
        end
        return whitelist[playerName] == true
    end)
    
    if success and isWhitelisted then
        ShowVerificationUI(true)
        wait(3)
        return true
    else
        ShowVerificationUI(false)
        wait(3)
        game.Players.LocalPlayer:Kick("未授权使用")
        return false
    end
end

if not UltimateValidation() then return end

-- ==================== 6. 游戏核心功能函数 ====================
-- 数值格式化
local f={[1]="",[2]="K",[3]="M",[4]="B",[5]="T",[6]="Qa",[7]="Qi"}
local function FormatNumber(num, decimals)
    local index = math.floor(math.log(math.max(1, math.abs(num)), 1000))
    local suffix = f[index + 1] or ("e" .. index)
    local formatted = math.floor(num * ((10^decimals) / (1000^index))) / (10^decimals)
    return string.format("%." .. decimals .. "f%s", formatted, suffix)
end

-- 统计变量
local lastStrength, samples, lastSampleTime, lastUpdateTime = 0, {}, 0, 0
local sampleInterval = 20
local maxSamples = 6

-- 检查加成状态
local function HasBoost()
    return pcall(function() return e.boostTimersFolder:FindFirstChild("Protein Egg") end)
end

-- 计算平均增益
local function GetAverageGain()
    if #samples == 0 then return 0 end
    local total = 0
    for _, gain in next, samples do total = total + (gain or 0) end
    return total / #samples
end

-- ==================== 7. 创建主GUI窗口 ====================
-- 注意：以下调用方式基于您之前提供的WindUILibrary格式，如果外部库API不同可能需要调整
local mainWindow = c:CreateWindow({
    Title = "Crazy Top",
    Icon = "rbxassetid://139743288604595", -- 请确认此ID有效
    Size = UDim2.fromOffset(290, 340),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 130,
    HasOutline = d
})

-- 设置打开按钮 (如果库支持)
if mainWindow.EditOpenButton then
    mainWindow:EditOpenButton({
        Title = "Crazy Top",
        Icon = "image-upscale",
        CornerRadius = UDim.new(0, 10),
        StrokeThickness = 3,
        Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29"))
    })
end

-- ==================== 8. 创建标签页与控件 ====================
local mainTab = mainWindow:Tab({Title = "Main", Icon = ""})

-- 统计信息显示
local statsParagraph = mainTab:Paragraph({
    Title = "Stats",
    Desc = "Loading...",
    Image = "users",
    ImageSize = 25
})

-- 更新统计信息的协程
coroutine.wrap(function()
    while wait(1) do
        pcall(function()
            local currentStrength = e.leaderstats.Strength.Value
            local currentTime = tick()
            
            if lastStrength > 0 then
                local gainPerSecond = (currentStrength - lastStrength) / (currentTime - lastSampleTime)
                
                if currentTime - lastUpdateTime >= sampleInterval then
                    table.insert(samples, gainPerSecond)
                    if #samples > maxSamples then table.remove(samples, 1) end
                    lastUpdateTime = currentTime
                end
            end
            
            lastStrength = currentStrength
            lastSampleTime = currentTime
            
            local avgGain = GetAverageGain()
            local hasBoost = HasBoost()
            
            -- 更新统计描述
            if statsParagraph and statsParagraph.SetDesc then
                statsParagraph:SetDesc(
                    "Strength: " .. FormatNumber(currentStrength, 1) .. 
                    "\nAvg Gain: " .. FormatNumber(avgGain, 1) .. "/s" ..
                    "\nDaily: " .. FormatNumber(avgGain * 86400, 1) ..
                    "\nMonthly: " .. FormatNumber(avgGain * 2592000, 1) ..
                    "\nSamples: " .. #samples .. "/" .. maxSamples ..
                    "\n" .. (hasBoost and "✅ Protein Egg x2" or "❌ No Boost")
                )
            end
        end)
    end
end)()

-- ==================== 9. 自动功能开关 ====================
-- 自动训练
_G.AutoTrain = false
local function AutoTrainLoop()
    while _G.AutoTrain do
        wait()
        pcall(function()
            if tostring(e.equippedPets.pet1.Value) == "Swift Samurai" then
                for i = 0, 19 do
                    e.muscleEvent:FireServer("rep")
                end
            end
        end)
    end
end

mainTab:Toggle({
    Title = "Auto Train",
    Desc = "Auto strength training",
    Value = false,
    Callback = function(value)
        _G.AutoTrain = value
        if value then AutoTrainLoop() end
    end
})

-- 自动使用蛋白蛋
_G.AutoEgg = false
local function AutoEggLoop()
    while _G.AutoEgg do
        wait(0.2)
        pcall(function()
            if not e.boostTimersFolder:FindFirstChild("Protein Egg") then
                local egg = e.Backpack:FindFirstChild("Protein Egg")
                if egg then
                    e.Character.Humanoid:EquipTool(egg)
                    wait(0.1)
                    if e.Character:FindFirstChild("Protein Egg") then
                        e.muscleEvent:FireServer("proteinEgg", e.Character:FindFirstChild("Protein Egg"))
                        wait(0.1)
                        e.Character.Humanoid:UnequipTools()
                    end
                end
            end
        end)
    end
end

mainTab:Toggle({
    Title = "Auto Egg",
    Desc = "Auto use Protein Egg",
    Value = false,
    Callback = function(value)
        _G.AutoEgg = value
        if value then AutoEggLoop() end
    end
})

-- ==================== 10. 清理UI功能 ====================
local function ClearGainUI()
    local coreGui = game:GetService("CoreGui")
    local playerGui = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
    
    local keywords = {"+", "Coins", "Coin", "Strength", "Exp", "Experience", "Level", "Damage", "Health"}
    local protectedNames = {"WindUI", "Crazy Top", "Rayfield"}
    
    -- 清理CoreGui
    for _, gui in ipairs(coreGui:GetChildren()) do
        if gui:IsA("ScreenGui") then
            local isProtected = false
            for _, name in ipairs(protectedNames) do
                if gui.Name:find(name) then
                    isProtected = true
                    break
                end
            end
            if not isProtected then
                local shouldRemove = false
                for _, element in ipairs(gui:GetDescendants()) do
                    if (element:IsA("TextLabel") or element:IsA("TextButton")) and element.Text then
                        for _, keyword in ipairs(keywords) do
                            if element.Text:find(keyword) or element.Text:find("%+%d+") then
                                shouldRemove = true
                                break
                            end
                        end
                        if shouldRemove then break end
                    end
                end
                if shouldRemove then gui:Destroy() end
            end
        end
    end
    
    -- 清理PlayerGui (类似逻辑)
    if playerGui then
        -- ... (实现类似的清理逻辑)
    end
end

mainTab:Button({
    Title = "Clear Gain UI",
    Desc = "Remove all gain notifications",
    Callback = ClearGainUI
})

-- ==================== 11. 脚本加载完成 ====================
print("Script loaded successfully!")
